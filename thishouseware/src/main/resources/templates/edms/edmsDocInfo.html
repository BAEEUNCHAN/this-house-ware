<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="Content">
<head>
<style>
/* 테이블 스타일 */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 16px;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* 테이블 헤더 스타일 */
th, td {
    padding: 12px;
    border-bottom: 1px solid #ddd;
}

th {
    background-color: #f4f4f4;
    font-weight: bold;
}

/* 라벨 스타일 */
label {
    font-weight: bold;
    margin-right: 10px;
}

/* 테이블 데이터 스타일 */
td span {
    display: block;
    color: #333;
}

/* 테이블 행 배경색 (홀수 행 스타일) */
tr:nth-child(odd) {
    background-color: #f9f9f9;
}

/* 버튼을 가운데 정렬 */
.button-container {
    text-align: center;
    margin-top: 20px;
}

button {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

button:hover {
    background-color: #0056b3;
}

/* 추가된 결재/반려 버튼 스타일 */
.custom-approve-btn {
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 16px;
    margin: 5px;
    cursor: pointer;
}

.custom-approve-btn:hover {
    background-color: #45A049;
}

.custom-reject-btn {
    background-color: #FF6347;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 16px;
    margin: 5px;
    cursor: pointer;
}

.custom-reject-btn:hover {
    background-color: #FF4500;
}

/* 반려 사유 모달 스타일 */
#rejectModal {
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
}

#rejectModal .modal-content {
    background-color: #fff;
    padding: 20px;
    width: 400px;
    max-width: 90%;
    border-radius: 10px;
    box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.3);
    position: relative;
}

#rejectModal h4 {
    margin-top: 0;
    font-size: 18px;
    font-weight: bold;
    color: #333;
    text-align: center;
}

#rejectModal textarea {
    width: 100%;
    height: 100px;
    margin-top: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 8px;
    resize: none;
    font-size: 14px;
}

#rejectModal .modal-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

#rejectModal .modal-footer button {
    width: 45%;
    padding: 8px;
    font-size: 14px;
}
.button-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

.btn-list {
    padding: 10px 20px;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.center-buttons {
    text-align: center;
    flex-grow: 1;
}

.center-buttons button {
    margin: 5px;
}
</style>
</head>

<body>
<div class="page-inner">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">결재문서 조회</div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="text-center">
                            <table class="table">
                                <tr>
                                    <td><label for="dno">문서번호</label></td>
                                    <td><span th:text="${edmsDocs.edmsDocNo}"></span></td>
                                </tr>
                               <tr>
										<td><label for="id">기안자</label></td>
										<td><span th:text="${edmsDocs.id}"></span></td>
									</tr>
                                <tr>
                                    <td><label for="dtitle">제목</label></td>
                                    <td><span th:text="${edmsDocs.title}"></span></td>
                                </tr>
                                <tr>
                                    <td><label for="dcontent">내용</label></td>
                                    <td><img id="edmsImg" class="card-img-top" alt="기안 이미지" width="400px" height="1500px" th:src="|/upload/${edmsDocs.fileName}|" ></td>                                    
                                </tr>
                                <tr>
                                    <td><label for="datt">첨부파일명</label></td>
                                    <td>
                                        <a th:if="${edmsDocs.attatch != null}" th:href="@{'fileDownload?fileLink=' + ${edmsDocs.attatch}}">파일 다운로드</a>
                                        <br>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label for="dsub">상신일시</label></td>
                                    <td><span th:text="${#dates.format(edmsDocs.submitDt, 'yyyy-MM-dd')}"></span></td>
                                </tr>
                                <tr>
                                    <td><label for="dappr">결재일시</label></td>
                                    <td><span th:text="${#dates.format(edmsDocs.approvalDt, 'yyyy-MM-dd')}"></span></td>
                                </tr>
                                <tr>
								    <td><label for="dstate">결재상태</label></td>
								    <td><span th:text="${edmsDocs.approvalStatus}"></span></td>
								</tr>
                                <tr>
                                    <td><label for="dformn">결재양식번호</label></td>
                                    <td><span th:text="${edmsDocs.edmsFormNo}"></span></td>
                                </tr>
                                <tr th:if="${edmsDocs.rejectReason != null}">
								    <td><label for="rejectReason">반려 사유</label></td>
								    <td><span th:text="${edmsDocs.rejectReason}"></span></td>
								</tr>
                            </table>
                            
                            <div class="button-container">
							    <button type="button" id="listButton" class="btn-list">목록</button>
							    <div class="center-buttons">
							        <button type="button" class="custom-approve-btn" id="approveButton"
							                th:if="${#authentication.principal.empVO.id == edmsDocs.currentApproverId and edmsDocs.approvalStatus != '결재완료' and edmsDocs.approvalStatus != '반려'}">
							            승인
							        </button>
							        <button type="button" class="custom-reject-btn" id="rejectButton"
							                th:if="${#authentication.principal.empVO.id == edmsDocs.currentApproverId and edmsDocs.approvalStatus != '결재완료' and edmsDocs.approvalStatus != '반려'}">
							            반려
							        </button>
							    </div>
							</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 반려 사유 모달 -->
<div id="rejectModal" style="display: none;">
    <div class="modal-content">
        <h4>반려 사유 입력</h4>
        <textarea id="rejectReason" placeholder="반려 사유를 입력하세요"></textarea>
        <div class="modal-footer">
            <button id="confirmReject" class="custom-reject-btn">반려</button>
            <button id="closeModal" class="custom-approve-btn">닫기</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
let approvalStatus = [[${edmsDocs.approvalStatus}]]
$(document).ready(function() {
    // 이미지 파일 링크를 가져와서 설정하는 부분
   /*  const imgLink = $('input[name=imageLink]').val(); 
    $('#edmsImg').attr({src: "/upload/" + imgLink});  */

    // 목록 버튼 클릭 시, 기본 문서 목록 페이지로 이동
    $('#listButton').on('click', function() {
        location.href = `/docBox/docApprovalStatusList?approvalStatus=${approvalStatus}`;  
    });

    // 승인 버튼 클릭 시, 결재 승인 요청을 서버로 전송
    $('#approveButton').on('click', function() {
        $.ajax({
            type: 'POST', 
            url: '/edms/approve', 
            data: { 
                edmsDocNo: [[${edmsDocs.edmsDocNo}]], // 문서 번호 전달
                approvalStatus: '승인' // 승인 상태 설정
            },
            success: function(response) {
                alert(response); 
                location.reload(); // 성공 시 페이지 새로고침
            },
            error: function(error) {
                alert("승인 처리 중 오류가 발생했습니다."); 
            }
        });
    });

    // 반려 버튼 클릭 시, 반려 사유 입력 모달을 표시
    $('#rejectButton').on('click', function() {
        $('#rejectModal').show(); // 반려 사유 모달 표시
    });

    // 모달의 닫기 버튼 클릭 시, 반려 사유 모달을 숨김
    $('#closeModal').on('click', function() {
        $('#rejectModal').hide();
    });

    // 반려 확인 버튼 클릭 시, 반려 요청을 서버로 전송
    $('#confirmReject').on('click', function() {
        let reason = $('#rejectReason').val(); // 입력된 반려 사유 가져옴
        if (reason) {
            // 반려 사유가 입력된 경우에만 요청 전송
            $.ajax({
                type: 'POST', 
                url: '/edms/reject', 
                data: { 
                    edmsDocNo: [[${edmsDocs.edmsDocNo}]], // 문서 번호
                    reason: reason // 반려 사유 전달
                },
                success: function(response) {
                    alert(response); 
                    location.reload(); // 성공 시 페이지 새로고침
                },
                error: function(error) {
                    alert("반려 처리 중 오류가 발생했습니다."); 
                }
            });
        } else {
            // 반려 사유가 입력되지 않은 경우 경고 메시지 표시
            alert("반려 사유를 입력해주세요.");
        }
    });
});
</script>
</body>
</html>