<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
  <meta charset="UTF-8">
  <title>Schedule</title>
  <!-- 화면 해상도에 따라 글자 크기 대응(모바일 대응) -->
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <!-- jquery CDN -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap 5 CDN -->
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- fullcalendar CDN -->  
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>  
	<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.14/index.global.min.js'></script>
  <!-- fullcalendar 언어 CDN -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>
      
  <style>
    /* body 스타일 */
    html, body {
      overflow: hidden;
      font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
      font-size: 14px;
    }
    /* 캘린더 위의 해더 스타일(날짜가 있는 부분) */
    .fc-header-toolbar {
      padding-top: 1em;
      padding-left: 1em;
      padding-right: 1em;
    }
    /* 일요일 날짜: 빨간색 */
    .fc-day-sun a {
      color: red;
    }
    /* 토요일 날짜: 파란색 */
    .fc-day-sat a {
      color: blue;
    }
    .fc-day-mon a{
      color: black;
    }
    .fc-day-tue a{
      color: black;
    }
    .fc-day-wed a {
      color: black;
    }
    .fc-day-thu a {
      color: black;
    }
    .fc-day-fri a {
      color: black;
    }
    
    .fc-event-title {
      color: black
    }
  </style>
</head>
<body style="padding:30px;">
  <!-- calendar 태그 -->
  <div id='calendar-container'>
    <div id='calendar'></div>
  </div>
  <!-- 부트스트랩 modal 부분 -->
  <!-- Modal -->
  <div
    class="modal fade"
    id="exampleModal"
    tabindex="-1"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">일정 추가하기</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          일정이름 : <input type="text" id="title" /><br />
          시작시간 : <input type="datetime-local" id="start" /><br />
          종료시간 : <input type="datetime-local" id="end" /><br />
          일정내용 : <textarea id="content" rows="5" cols="30"></textarea><br />
          배경색상 :
          <select id="color">
            <option value="red">빨강색</option>
            <option value="orange">주황색</option>
            <option value="yellow">노랑색</option>
            <option value="green">초록색</option>
            <option value="blue">파랑색</option>
            <option value="indigo">남색</option>
            <option value="purple">보라색</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            취소
          </button>
          <button type="button" class="btn btn-primary" id="saveChanges">
            추가
          </button>
        </div>
      </div>
    </div>
  </div>
  <script th:inline="javascript">
    let key = [[${key}]];
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');    
      fetch('/schListAll', {
      	method: "POST",
      	headers: {
            "Content-Type": "application/json",            
        },
      })
        .then(result => result.json())
        .then(result => {
          console.log(result);
          allEvents = result;
  
          // full-calendar 생성하기
          var calendar = new FullCalendar.Calendar(calendarEl, {
            themeSystem: 'bootstrap5', // Bootstrap 5 Theming
            googleCalendarApiKey: key,// 구글캘린더 api키 입력하시면 됩니다.
            height: '600px', // calendar 높이 설정
            expandRows: true, // 화면에 맞게 높이 재설정
            slotMinTime: '00:00', // Day 캘린더에서 시작 시간
            slotMaxTime: '23:59', // Day 캘린더에서 종료 시간
            customButtons:{
              myCustomButton:{
                text:"일정추가",
                click : function(){
                  //부트스트랩 모달 열기
                  $("#exampleModal").modal("show");              
                }
              },
              mySaveButton:{
                text:"저장하기",
                click: async function () {
                  if (confirm("저장하시겠습니까?")) {
                    //지금까지 생성된 모든 이벤트 저장하기
                    var allEvent = calendar.getEvents();
                    console.log("모든 이벤트들", allEvent);
                    //이벤트 저장하기
                    const saveEvent = await axios({ // 자신의 환경에 맞게 수정, https://greed-yb.tistory.com/274 참고
                      method: "POST",
                      url: "/calendar",
                      data: allEvent,
                    });
                  }
                },
              }
            },
            // 해더에 표시할 툴바
            headerToolbar: {
              left: 'prev,next today myCustomButton,mySaveButton',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay listWeek'
            },
            initialView: 'dayGridMonth', // 초기 로드 될때 보이는 캘린더 화면(기본 설정: 달)
            // initialDate: '2024-10-15', // 초기 날짜 설정 (설정하지 않으면 오늘 날짜가 보인다.)
            // slotDuration: '01:00:00', // 기본 30분 단위가 아니라 1시간 단위로 일정(일) 설정
            navLinks: true, // 날짜를 선택하면 Day 캘린더나 Week 캘린더로 링크
            editable: true, // default : false 이벤트 드래그 등의 편집여부를 설정함
            selectable: true, // 달력 일자 드래그 설정가능
            nowIndicator: true, // 현재 시간 마크
            allDaySlot:false, // timegrid 화면에서  allday 슬롯 제외하기
            dayMaxEvents: true, // 이벤트가 오버되면 높이 제한 (+ 몇 개식으로 표현)
            locale: 'ko', // 한국어 설정

            eventAdd: function (obj) {      // 이벤트 추가 시 발생하는 이벤트
              console.log("eventAdd : " + obj);
            },
            eventChange: function (obj) {    // 이벤트 수정 시 발생하는 이벤트
              console.log("eventChange : " + obj);
            },
            eventRemove: function (obj) {     // 이벤트 삭제 시 발생하는 이벤트
              console.log("eventRemove : " + obj);
            },
            select: function(arg) { // 캘린더에서 드래그로 이벤트를 생성할 수 있다. https://greed-yb.tistory.com/274 참고
              let title = prompt('일정 추가');
              if (title) {
                calendar.addEvent({
                  title: title,
                  start: arg.start,
                  end: arg.end,
                  allDay: arg.allDay
                })
              }
              calendar.unselect()
            },
            eventClick: function (arg) {    // 일정 클릭 시, https://greed-yb.tistory.com/274 참고
              if (confirm("선택한 일정을 삭제하시겠습니까?")) {                        
                arg.event.remove();
                alert("삭제하였습니다.");
              }else{
                alert("오류가 발생하였습니다");
              }
            },
            //데이터 가져오는 이벤트
            //데이터 가져오는 이벤트
            eventSources:[
              {
            	events: allEvents,
            	/*
                events: async function (info, successCallback, failureCallback) {              
                  //이벤트에 넣을 배열 선언하기
                  const eventArray = [];
                  allEvents.forEach((res) => {
                    eventArray.push({
                      title: res.title,
                      start: res.start,
                      end: res.end,
                      // backgroundColor: res.backgroundColor,
                    });
                  });
                  successCallback(eventArray);
                },
                */
              },
              {
                googleCalendarId : 'ko.south_korea.official#holiday@group.v.calendar.google.com',
                backgroundColor: 'red',
              }
            ]
        });

      //모달창 이벤트
      $("#saveChanges").on("click", function () {
        var eventData = {
          title: $("#title").val(),
          start: $("#start").val(),
          end: $("#end").val(),
          content: $("#content").val(),
          color: $("#color").val(),
        };
        //빈값입력시 오류
        if (
          eventData.title == "" ||
          eventData.start == "" ||
          eventData.end == ""
        ) {
          alert("입력하지 않은 값이 있습니다.");

          //끝나는 날짜가 시작하는 날짜보다 값이 크면 안됨
        } else if ($("#start").val() > $("#end").val()) {
          alert("시간을 잘못 입력 하셨습니다.");
        } else {
          // 이벤트 추가
          calendar.addEvent(eventData);
          $("#exampleModal").modal("hide");
          $("#title").val("");
          $("#start").val("");
          $("#end").val("");
          $("#content").val("");
          $("#color").val("");
        }
      });
      // 캘린더 랜더링
      calendar.render();
    });
  });  
  /*
  - 일정 저장시 고려해야 할 DB 테이블
  1. title : 일정 이름
  2. start : 일정 시작 시간
  3. end : 일정이 끝나는 시간
  4. backgroundColor : 일정 배경색

  - 일정 저장시 공휴일 일정은 제외하기
  내가 입력한 일정의 url값은 undefined이다
  예제)
  exports.calendar = async (req, res) => {
    await req.body.forEach((res) => {
      if(res.url) == undefined) {
        calendar.create({
          title: res.title,
          start: res.start,
          end: res.end,
          backgroundColor: res.backgroundColor,
        });
      }
    });
  }
  */
</script>
</body>
</html>